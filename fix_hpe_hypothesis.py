"""
HPE hypothesis 疾患名クリーンアップスクリプト

全foreground HPE項目から疾患名を除去し、
病態生理・メカニズム・記述語に置換する。

背景カテゴリ（既往歴, 薬剤歴, 嗜好/社会歴, 家族歴）はスキップ。

Usage:
    python fix_hpe_hypothesis.py              # 実行
    python fix_hpe_hypothesis.py --dry-run    # 変更内容を表示のみ
"""

import json
import sys

HPE_ITEMS_PATH = "data/hpe_items.jsonl"

# item_name → 新しいhypothesis のマッピング
# 疾患名を除去し、メカニズム・記述語に置換
FIXES = {
    # === OPQRST:Provocation ===
    "前屈位で軽快":
        "前屈位で軽快 座位前傾姿勢で改善 後腹膜臓器圧迫緩和 心嚢摩擦軽減",
    "寒冷曝露で誘発":
        "寒冷曝露 冷気 冷水で症状誘発 冠血管攣縮 末梢血管攣縮 蒼白→紫→紅潮",
    "ニトログリセリン反応性":
        "ニトログリセリン舌下で軽快 胸痛消失 冠血管拡張反応性",

    # === OPQRST:Quality ===
    "拍動性":
        "拍動性 ズキズキ 脈打つような 血管拍動性疼痛",
    "裂けるような":
        "裂けるような 引き裂かれる 移動する痛み 血管壁損傷 大血管疾患",
    "灼熱感":
        "灼熱感 焼けるような ヒリヒリ 粘膜酸性刺激 神経障害性疼痛",

    # === OPQRST:Region ===
    "左肩・左腕放散":
        "左肩 左腕 左顎への放散痛 心臓関連痛 内臓関連痛",
    "右下腹部痛":
        "右下腹部痛 McBurney点 右腸骨窩 回盲部病変",
    "左下腹部痛":
        "左下腹部痛 S状結腸部 左腸骨窩 大腸壁内病変",
    "側腹部痛":
        "側腹部痛 CVA叩打痛部 腎部痛 尿路系病変 腎実質炎症",
    "びまん性腹痛":
        "びまん性腹痛 腹部全体 汎発性 腹膜刺激",
    "後頭部痛":
        "後頭部痛 項部 うなじの痛み 髄膜刺激 頭蓋内圧変化",
    "片側頭痛":
        "片側頭痛 一側性 こめかみ 血管拍動性 三叉神経領域",
    "眼窩周囲痛":
        "眼窩周囲痛 眼の奥 眼窩部 三叉神経領域 副鼻腔圧迫",
    "多関節痛":
        "多関節痛 複数の関節 対称性 自己免疫性滑膜炎",
    "単関節痛":
        "単関節痛 一つの関節のみ 急性 結晶沈着 関節内感染",

    # === OPQRST:Time ===
    "持続性（>20分）":
        "持続性 20分以上持続 改善しない 心筋虚血 不可逆的損傷",
    "反復性エピソード":
        "反復性 以前も同様のエピソード 再発 管腔内結石 間欠的閉塞",
    "早朝・夜間増悪":
        "早朝 朝方 夜間増悪 起床時 気道過敏性 体液再分布",

    # === ROS:全身 ===
    "体重減少":
        "体重減少 意図しない 数か月 食欲低下 消耗 カタボリズム亢進",
    "体重増加":
        "体重増加 浮腫 腹水 全身性浮腫 代謝低下 体液貯留",
    "盗汗":
        "盗汗 寝汗 夜間発汗 着替えが必要 シーツが濡れる 慢性炎症",

    # === ROS:頭頸 ===
    "頭痛（急性・新規）":
        "急性頭痛 新規発症 突然の激しい頭痛 髄膜刺激 頭蓋内圧急変",
    "頭痛（慢性・反復性）":
        "慢性頭痛 反復性 定期的再発 前兆あり 筋緊張性 鎮痛薬依存",
    "めまい（回転性）":
        "めまい 回転性 ぐるぐる 天井が回る 前庭機能異常 内リンパ水腫",
    "めまい（浮動性）":
        "めまい 浮動性 ふわふわ ふらつき 起立時増悪 脳幹血流低下",
    "嗄声":
        "嗄声 声がれ 声の変化 声帯麻痺 反回神経障害 喉頭病変",

    # === ROS:眼 ===
    "眼痛":
        "眼痛 眼の痛み 充血 涙 羞明 眼圧上昇",

    # === ROS:胸部 ===
    "喀血":
        "喀血 血痰 気道出血 大量喀血 気道粘膜破綻 肺血管損傷",

    # === ROS:心血管 ===
    "下肢浮腫":
        "下肢浮腫 足のむくみ 圧痕性浮腫 夕方増悪 静脈還流障害 体液過剰",

    # === ROS:消化器 ===
    "便秘":
        "便秘 排便困難 排便減少 腹部膨満 腸管通過障害",
    "腹部膨満":
        "腹部膨満 お腹が張る 腹水 ガス貯留 腸管拡張",
    "血尿":
        "血尿 肉眼的血尿 尿が赤い 尿路粘膜損傷 糸球体障害",

    # === ROS:泌尿器 ===
    "尿量変化":
        "尿量減少 乏尿 無尿 多尿 糸球体濾過率変化 浸透圧利尿",

    # === ROS:筋骨格 ===
    "朝のこわばり":
        "朝のこわばり 関節のこわばり 30分以上 1時間以上 自己免疫性滑膜炎",

    # === ROS:皮膚 ===
    "紫斑":
        "紫斑 あざ 皮下出血 点状出血 血小板減少 凝固障害",
    "掻痒":
        "掻痒 かゆみ 全身性 局所性 胆汁うっ滞 尿毒素蓄積 リンパ増殖",

    # === ROS:神経 ===
    "痙攣":
        "痙攣 けいれん 全身性 部分性 異常放電 意識消失",

    # === ROS:精神 ===
    "不安":
        "不安 不安感 パニック 緊張 カテコラミン過剰 代謝亢進",

    # === ROS:内分泌 ===
    "多飲多尿":
        "多飲多尿 口渇 水をたくさん飲む 浸透圧利尿 水再吸収障害",
    "耐暑性/耐寒性変化":
        "耐暑性低下 暑がり 耐寒性低下 寒がり 基礎代謝変動 甲状腺ホルモン異常",
    "異食症":
        "異食症 氷をかじる pagophagia 土を食べる 鉄欠乏",

    # === PE:髄膜刺激 ===
    "項部硬直":
        "項部硬直 頸部硬直 受動的頸部前屈で抵抗 髄膜刺激徴候",
    "Kernig徴候":
        "Kernig徴候 陽性 膝伸展制限 髄膜刺激徴候",
    "Jolt accentuation":
        "Jolt accentuation 陽性 頭部左右振りで頭痛増悪 髄膜刺激徴候",

    # === PE:腹部徴候 ===
    "Murphy徴候":
        "Murphy徴候 陽性 右季肋部圧痛 吸気時停止 胆嚢壁炎症",
    "McBurney圧痛":
        "McBurney点圧痛 陽性 右下腹部 臍と右上前腸骨棘 回盲部炎症",
    "Blumberg徴候（反跳痛）":
        "Blumberg徴候 陽性 反跳痛 腹膜刺激徴候",
    "Rovsing徴候":
        "Rovsing徴候 陽性 左下腹部圧迫で右下腹部痛 回盲部炎症",
    "Heel drop test":
        "Heel drop test 踵落とし試験 陽性 腹膜刺激徴候",
    "CVA叩打痛":
        "CVA叩打痛 肋骨脊柱角 叩打痛 腎実質炎症 尿路系病変",

    # === PE:心血管徴候 ===
    "頸静脈怒張(JVD)":
        "頸静脈怒張 JVD 中心静脈圧上昇 右心負荷 静脈還流障害",
    "Kussmaul徴候":
        "Kussmaul徴候 吸気時頸静脈怒張増強 心嚢拘束 右室コンプライアンス低下",
    "Levine徴候":
        "Levine徴候 胸の前で拳を握る 心筋虚血性胸痛",
    "S3 gallop":
        "S3 gallop III音 奔馬調律 容量負荷 左室拡張 急速充満",
    "心雑音":
        "心雑音 収縮期雑音 拡張期雑音 弁膜異常 新規出現 心内構造物付着",
    "心膜摩擦音":
        "心膜摩擦音 pericardial friction rub 心膜摩擦 座位前傾で増強",

    # === PE:甲状腺/内分泌 ===
    "甲状腺腫大":
        "甲状腺腫大 びまん性 結節性 甲状腺触診 自己免疫性甲状腺炎",
    "甲状腺bruit":
        "甲状腺bruit 血管雑音 甲状腺血流増加 過形成 代謝亢進",
    "眼球突出":
        "眼球突出 exophthalmos Hertel 眼窩後方組織腫脹 自己免疫性眼窩炎症",
    "手指微細振戦":
        "手指微細振戦 tremor 紙を載せて確認 交感神経緊張 代謝亢進",

    # === PE:眼科的所見 ===
    "瞳孔不同":
        "瞳孔不同 anisocoria 左右差 脳ヘルニア 動眼神経麻痺 交感神経障害",

    # === PE:DVT/血管 ===
    "下腿腫脹左右差":
        "下腿腫脹左右差 片側性浮腫 深部静脈還流障害 下腿周径差",
    "Homans徴候":
        "Homans徴候 足関節背屈時腓腹筋痛 深部静脈還流障害",

    # === PE:出血徴候 ===
    "Cullen徴候":
        "Cullen徴候 臍周囲皮下出血 後腹膜出血 腹腔内出血",
    "Grey-Turner徴候":
        "Grey-Turner徴候 側腹部皮下出血 後腹膜出血",
    "点状出血":
        "点状出血 petechiae 血小板減少 凝固障害 微小血管障害",

    # === PE:貧血徴候 ===
    "匙状爪":
        "匙状爪 koilonychia spoon nail 長期鉄欠乏 爪基質変化",
    "舌炎/口角炎":
        "舌炎 Hunter舌炎 口角炎 舌乳頭萎縮 平滑舌 栄養素欠乏 造血障害",

    # === PE:膠原病 ===
    "蝶形紅斑":
        "蝶形紅斑 malar rash 頬部紅斑 鼻唇溝を避ける 自己免疫性皮膚炎",
    "Raynaud現象":
        "Raynaud現象 冷感曝露 白→紫→赤 三相性色調変化 血管攣縮 微小循環障害",
    "爪囲毛細血管異常":
        "爪囲毛細血管異常 nailfold capillaroscopy 拡張 出血 微小血管障害 結合組織異常",
    "Gottron丘疹":
        "Gottron丘疹 手指関節背面 紫紅色丘疹 炎症性筋疾患の皮膚症状",

    # === PE:肺聴診 ===
    "Crackles":
        "Crackles 捻髪音 水泡音 fine coarse 肺胞内液体 間質浮腫 気道分泌物",
    "Wheeze":
        "Wheeze 喘鳴 呼気性 吸気性 気道狭窄 気管支攣縮 気道炎症",
    "呼吸音減弱/消失":
        "呼吸音減弱 呼吸音消失 含気消失 胸腔内液体貯留 肺虚脱",
    "胸膜摩擦音":
        "胸膜摩擦音 pleural friction rub 胸膜摩擦 吸気呼気両方",
    "Stridor":
        "Stridor 吸気性喘鳴 上気道狭窄 声門上浮腫 気道内異物 気道圧排",

    # === PE:腹部診察 ===
    "心窩部圧痛":
        "心窩部圧痛 上腹部圧痛 胃十二指腸 膵臓 上腹部臓器炎症",
    "右上腹部圧痛":
        "右上腹部圧痛 右季肋部圧痛 胆嚢 肝臓 肝胆道系炎症",
    "筋性防御":
        "筋性防御 guarding 腹壁緊張 板状硬 腹膜刺激 管腔臓器破綻",
    "腸蠕動音":
        "腸蠕動音 亢進 金属音 減弱 消失 腸管通過障害 腸管運動異常",
    "肝腫大":
        "肝腫大 肝臓触知 肝下縁 肝実質病変 静脈うっ滞 うっ血",
    "脾腫":
        "脾腫 脾臓触知 感染症 血液疾患 門脈圧亢進 網内系過形成",
    "腹水":
        "腹水 波動 shifting dullness 腹部膨満 門脈圧亢進 低アルブミン血症",
    "腹部拍動性腫瘤":
        "腹部拍動性腫瘤 大血管拡張 拡張性拍動 動脈壁変性",

    # === PE:神経診察 ===
    "片麻痺":
        "片麻痺 一側性運動障害 上肢下肢 Barré徴候 錐体路障害",

    # === PE:皮膚所見 ===
    "蕁麻疹":
        "蕁麻疹 膨疹 I型アレルギー IgE介在性 肥満細胞脱顆粒 全身反応",
    "壊疽":
        "壊疽 組織壊死 黒色変化 血行障害 末梢動脈閉塞 軟部組織感染",
    "Janeway病変":
        "Janeway病変 手掌足底 無痛性紅斑 細菌塞栓 微小血管閉塞",
    "Osler結節":
        "Osler結節 指趾 有痛性結節 免疫複合体沈着 微小血管炎",
    "結節性紅斑":
        "結節性紅斑 下腿前面 有痛性紅色結節 全身性炎症の皮膚症状 脂肪織炎",

    # === PE:リンパ節 ===
    "頸部リンパ節腫大":
        "頸部リンパ節腫大 前頸部 後頸部 感染 リンパ増殖性疾患 転移性病変",
    "腋窩リンパ節腫大":
        "腋窩リンパ節腫大 感染 リンパ増殖性疾患 領域リンパ節転移",
    "全身性リンパ節腫大":
        "全身性リンパ節腫大 複数領域 リンパ増殖性疾患 全身感染症 肉芽腫性疾患",

    # === PE:四肢 ===
    "下肢浮腫（圧痕性）":
        "下肢浮腫 圧痕性 pitting edema 心拍出量低下 蛋白喪失 門脈圧亢進",
    "ばち指":
        "ばち指 clubbing 指趾先端腫大 慢性低酸素 肺内シャント 慢性炎症性疾患",
    "関節変形":
        "関節変形 スワンネック ボタン穴 尺側偏位 滑膜増殖性関節破壊",

    # === PE:整形外科的 ===
    "SLR test":
        "SLR test 下肢伸展挙上テスト 陽性 神経根圧迫 腰仙部神経刺激",
    "Lachman test":
        "Lachman test 陽性 膝前方不安定性 靭帯損傷",
    "McMurray test":
        "McMurray test 陽性 膝関節内構造障害 クリック音 嵌頓感",
    "Phalen test":
        "Phalen test 陽性 正中神経圧迫 手掌しびれ 神経絞扼",
    "Tinel徴候":
        "Tinel徴候 陽性 叩打で放散痛 神経絞扼",
    "Neer test":
        "Neer test 陽性 肩峰下での腱板圧迫 肩関節挙上時疼痛",

    # === PE:特殊徴候 ===
    "Trousseau徴候":
        "Trousseau徴候 血圧計加圧で手の攣縮 低Ca血症 神経筋興奮性亢進",
    "Chvostek徴候":
        "Chvostek徴候 顔面神経叩打で顔面筋攣縮 低Ca血症 神経筋興奮性亢進",
    "起立試験":
        "起立試験 起立時血圧低下 頻脈 起立不耐症 循環血液量減少 自律神経障害",
    "Dix-Hallpike test":
        "Dix-Hallpike test 陽性 後半規管耳石 頭位変換性眼振",
    "Head impulse test":
        "Head impulse test HIT 陽性 前庭機能障害 半規管機能低下 catch-up saccade",
    "歩行評価":
        "歩行評価 歩行障害 失調性 痙性 小刻み 動揺性 基底核障害",
    "腱黄色腫":
        "腱黄色腫 アキレス腱肥厚 脂質沈着 遺伝性脂質代謝異常",
}


def main():
    dry_run = "--dry-run" in sys.argv

    # 読み込み
    items = []
    with open(HPE_ITEMS_PATH, "r", encoding="utf-8") as f:
        for line in f:
            if line.strip():
                items.append(json.loads(line.strip()))

    print(f"全HPE項目: {len(items)}件")

    changed = 0
    unchanged_fixes = []

    for item in items:
        name = item["item_name"]
        if name in FIXES:
            old_hyp = item["hypothesis"]
            new_hyp = FIXES[name]
            if old_hyp != new_hyp:
                if dry_run:
                    print(f"\n[{name}]")
                    print(f"  OLD: {old_hyp}")
                    print(f"  NEW: {new_hyp}")
                item["hypothesis"] = new_hyp
                changed += 1
            else:
                unchanged_fixes.append(name)

    if unchanged_fixes:
        print(f"\n既に修正済み: {len(unchanged_fixes)}件")
        for name in unchanged_fixes:
            print(f"  - {name}")

    print(f"\n変更: {changed}件")

    if not dry_run and changed > 0:
        with open(HPE_ITEMS_PATH, "w", encoding="utf-8") as f:
            for item in items:
                f.write(json.dumps(item, ensure_ascii=False) + "\n")
        print(f"書き込み完了: {HPE_ITEMS_PATH}")
        print("\n次のステップ:")
        print("  del data\\sim_matrix_hpe.npz data\\hpe_name_embs.npz  # キャッシュ削除")
    elif dry_run:
        print("\n--dry-run: 書き込みは行いません")


if __name__ == "__main__":
    main()
