"""
包括的検証: 全ての残課題を洗い出す
ケースA-G(既存) + H-N(新規) で網羅的にテスト
"""
from engine import VeSMedEngine
import copy

print("エンジン初期化中...")
eng = VeSMedEngine()


def find_rank(candidates, disease_name):
    sorted_c = sorted(candidates, key=lambda x: x.get('similarity', 0), reverse=True)
    for i, c in enumerate(sorted_c):
        if c['disease_name'] == disease_name:
            return i + 1
    return -1


def run_case(case_name, symptoms, results, targets, wrong_targets=None):
    print(f"\n{'='*70}")
    print(f"  {case_name}")
    print(f"{'='*70}")

    cands = eng.search_diseases(symptoms)
    cands = eng.compute_priors(cands)
    cands_opt3 = copy.deepcopy(cands)
    cands_opt3 = eng.update_from_results(cands_opt3, results, symptoms=symptoms, mode="fast")

    print(f"\n  {'疾患':<25s} | {'初回':>4s} | {'新':>4s} | 判定")
    print(f"  {'-'*55}")

    all_targets = targets + (wrong_targets or [])
    ok_count = 0
    ng_count = 0
    for name, label in all_targets:
        r_init = find_rank(cands, name)
        r_new = find_rank(cands_opt3, name)

        is_wrong = wrong_targets and (name, label) in wrong_targets
        if is_wrong:
            if r_new > r_init:
                judge = "OK"
                ok_count += 1
            elif r_new < r_init:
                judge = "NG"
                ng_count += 1
            else:
                judge = "--"
        else:
            if r_new < r_init:
                judge = "OK"
                ok_count += 1
            elif r_new > r_init:
                judge = "NG"
                ng_count += 1
            else:
                judge = "--"

        r_init_s = f"{r_init:>4d}" if r_init > 0 else "  N/A"
        r_new_s = f"{r_new:>4d}" if r_new > 0 else "  N/A"
        print(f"  {label:<25s} | {r_init_s} | {r_new_s} | {judge}")

    return ok_count, ng_count


total_ok = 0
total_ng = 0

# ================================================================
# 既存ケース（改良確認）
# ================================================================

# ケースA: 定性正常 — 肝胆道除外
ok, ng = run_case(
    "A: 定性正常（γ-GTP正常、D-Bil正常、MRCP異常なし）",
    "47歳女性。来院1日前から左脇～背中の痛み、全身痛、嘔吐、水様便。当日39度の発熱。",
    ['γ-GTP正常値', '直接ビリルビン正常値', 'MRCP異常なし'],
    targets=[('劇症型溶血性レンサ球菌感染症（STSS）', 'STSS'), ('壊死性筋膜炎', '壊死性筋膜炎')],
    wrong_targets=[('総胆管結石', '総胆管結石(誤)'), ('急性胆管炎', '急性胆管炎(誤)')],
)
total_ok += ok; total_ng += ng

# ケースB: 定性異常 — IE確定
ok, ng = run_case(
    "B: 定性異常（血培陽性、心エコー疣贅、CRP上昇）",
    "67歳男性。7週間前から38度前後の繰り返す発熱。体重減少、食欲低下、全身倦怠感。",
    ['血液培養: 黄色ブドウ球菌陽性', '心エコー: 大動脈弁に疣贅あり', 'CRP上昇'],
    targets=[('感染性心内膜炎', 'IE(正解)'), ('敗血症', '敗血症')],
    wrong_targets=[('成人スティル病', 'スティル病(誤)')],
)
total_ok += ok; total_ng += ng

# ケースC: 半定量
ok, ng = run_case(
    "C: 半定量（尿蛋白+++、尿潜血+）",
    "45歳男性。2週間前から両下肢の浮腫が進行。顔面浮腫も出現。泡立つ尿に気づいた。",
    ['尿蛋白(+++)', '尿潜血(+)'],
    targets=[('微小変化型ネフローゼ症候群', 'ネフローゼ'), ('IgA腎症', 'IgA腎症')],
    wrong_targets=[('深部静脈血栓症', 'DVT(誤)')],
)
total_ok += ok; total_ng += ng

# ケースD: 数値高値
ok, ng = run_case(
    "D: 数値高値（WBC 18000, CRP 15）",
    "47歳女性。来院1日前から左脇～背中の痛み、全身痛、嘔吐、水様便。当日39度の発熱。",
    ['WBC 18000', 'CRP 15'],
    targets=[('劇症型溶血性レンサ球菌感染症（STSS）', 'STSS'), ('敗血症', '敗血症')],
)
total_ok += ok; total_ng += ng

# ケースE: 逆方向異常
ok, ng = run_case(
    "E: 逆方向異常（WBC 2000, 体温 35度）",
    "65歳男性。3日前から発熱と悪寒。本日意識レベル低下、血圧低下で搬送。",
    ['WBC 2000', '体温 35度'],
    targets=[('敗血症', '敗血症'), ('敗血症性ショック', '敗血症性ショック')],
)
total_ok += ok; total_ng += ng

# ケースF: 正常数値
ok, ng = run_case(
    "F: 正常数値（Na 140, Hb 14）",
    "55歳男性。胸痛で来院。30分前から突然の胸骨後部痛。冷汗あり。",
    ['Na 140', 'Hb 14'],
    targets=[('急性心筋梗塞 (STEMI：前壁/中隔)', 'AMI')],
)
total_ok += ok; total_ng += ng

# ケースG: 混合
ok, ng = run_case(
    "G: 混合（血培陽性 + 胸部X線正常 + 尿培陰性）",
    "72歳男性。5日前から38度台の発熱持続。悪寒戦慄を伴う。",
    ['血液培養: 黄色ブドウ球菌陽性', '胸部X線異常なし', '尿培養陰性'],
    targets=[('感染性心内膜炎', 'IE'), ('敗血症', '敗血症')],
    wrong_targets=[('肺炎球菌性肺炎', '肺炎(誤)'), ('急性腎盂腎炎', '腎盂腎炎(誤)')],
)
total_ok += ok; total_ng += ng

# ================================================================
# 新規ケース: バイタルサイン
# ================================================================

ok, ng = run_case(
    "H: バイタルサイン数値（体温 39.5, 血圧 80/50, 脈拍 120）",
    "70歳男性。尿路感染後に高熱、意識混濁。",
    ['体温 39.5', '血圧 80/50', '脈拍 120'],
    targets=[('敗血症', '敗血症'), ('敗血症性ショック', '敗血症性ショック')],
)
total_ok += ok; total_ng += ng

ok, ng = run_case(
    "I: バイタルサイン定性（低体温、低血圧、頻脈）",
    "70歳男性。尿路感染後に高熱、意識混濁。",
    ['低体温', '低血圧', '頻脈'],
    targets=[('敗血症', '敗血症'), ('敗血症性ショック', '敗血症性ショック')],
)
total_ok += ok; total_ng += ng

# ================================================================
# 新規ケース: 肝機能
# ================================================================

ok, ng = run_case(
    "J: 肝機能数値（AST 450, ALT 380, T-Bil 5.2）",
    "35歳男性。1週間前から倦怠感、食欲不振。3日前から眼球黄染。",
    ['AST 450', 'ALT 380', 'T-Bil 5.2'],
    targets=[('急性B型肝炎', '急性肝炎'), ('アルコール性肝炎', 'アルコール性肝炎')],
    wrong_targets=[('急性心筋梗塞 (STEMI：前壁/中隔)', 'AMI(誤)')],
)
total_ok += ok; total_ng += ng

# ================================================================
# 新規ケース: 腎機能
# ================================================================

ok, ng = run_case(
    "K: 腎機能数値（Cr 4.5, BUN 65, K 6.2）",
    "60歳男性。糖尿病歴20年。1週間前から全身浮腫、尿量減少。",
    ['Cr 4.5', 'BUN 65', 'K 6.2'],
    targets=[('慢性腎臓病 (CKD)', 'CKD'), ('糖尿病性腎症', '糖尿病性腎症')],
)
total_ok += ok; total_ng += ng

# ================================================================
# 新規ケース: 甲状腺
# ================================================================

ok, ng = run_case(
    "L: 甲状腺数値（TSH 0.01, Free T4 5.8）",
    "28歳女性。動悸、手指振戦、体重減少、発汗過多。眼球突出あり。",
    ['TSH 0.01', 'Free T4 5.8'],
    targets=[('バセドウ病', 'バセドウ病')],
)
total_ok += ok; total_ng += ng

# ================================================================
# 新規ケース: 貧血
# ================================================================

ok, ng = run_case(
    "M: 貧血数値（Hb 6.5, MCV低下, フェリチン 3）",
    "45歳女性。3ヶ月前から徐々に息切れ、動悸。月経過多の既往。",
    ['Hb 6.5', 'フェリチン 3'],
    targets=[('鉄欠乏性貧血', '鉄欠乏性貧血')],
)
total_ok += ok; total_ng += ng

# ================================================================
# 新規ケース: 正常+異常の混合（数値）
# ================================================================

ok, ng = run_case(
    "N: 数値混合（トロポニンT上昇 + Na正常 + Cr正常）",
    "65歳男性。2時間前から胸骨後部の激痛。冷汗、嘔気あり。",
    ['トロポニンT 0.5', 'Na 141', 'Cr 0.8'],
    targets=[('急性心筋梗塞 (STEMI：前壁/中隔)', 'AMI'), ('不安定狭心症', 'ACS')],
    wrong_targets=[('慢性腎臓病 (CKD)', 'CKD(誤)')],
)
total_ok += ok; total_ng += ng

# ================================================================
# 新規ケース: 日本語表記の数値
# ================================================================

ok, ng = run_case(
    "O: 日本語表記（白血球 25000, CRP 20, 血小板 3万）",
    "50歳男性。3日前から高熱、咳嗽、膿性痰。呼吸困難増悪。",
    ['白血球 25000', 'CRP 20', '血小板 3'],
    targets=[('肺炎球菌性肺炎', '肺炎'), ('敗血症', '敗血症')],
)
total_ok += ok; total_ng += ng

# ================================================================
# 新規ケース: 画像+定性混合
# ================================================================

ok, ng = run_case(
    "P: 画像+定性（CT: 膵腫大あり + リパーゼ上昇 + アミラーゼ上昇）",
    "50歳男性。突然の上腹部痛、背部に放散。大量飲酒歴あり。",
    ['腹部CT: 膵腫大あり', 'リパーゼ上昇', 'アミラーゼ上昇'],
    targets=[('急性膵炎', '急性膵炎')],
    wrong_targets=[('急性胆嚢炎', '急性胆嚢炎(誤)')],
)
total_ok += ok; total_ng += ng


# ================================================================
# サマリー
# ================================================================
print(f"\n\n{'='*70}")
print(f"包括的検証完了")
print(f"  OK: {total_ok}件 / NG: {total_ng}件")
print(f"{'='*70}")
