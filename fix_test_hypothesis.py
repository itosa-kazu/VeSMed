"""
検査 hypothesis_text 疾患名クリーンアップスクリプト

hypothesis_text中の疾患名を病態生理・メカニズム記述に置換する。
病原体名（肺炎球菌、レジオネラ等）は保持。

方式:
1. 個別オーバーライド辞書（最優先）
2. 汎用 疾患名→メカニズム マッピング
3. 非標準フォーマット項目の完全書き換え

Usage:
    python fix_test_hypothesis.py              # 実行
    python fix_test_hypothesis.py --dry-run    # 変更内容を表示のみ
"""

import json
import sys
import re

TESTS_JSONL = "data/tests.jsonl"

# ===================================================================
# 個別オーバーライド（test_name → 新hypothesis_text）
# 複雑な項目や非標準フォーマットはここで完全指定
# ===================================================================
OVERRIDES = {
    # --- 極性分岐あり（TSH系、PTH系等）---
    "TSH":
        "TSH異常を認めた。高値は甲状腺ホルモン分泌低下に対する下垂体代償、低値は甲状腺ホルモン過剰またはTSH分泌低下を示唆する",
    "Free T3":
        "Free T3異常を認めた。高値は甲状腺ホルモン過剰産生、低値は甲状腺ホルモン合成低下を示唆する",
    "Free T4":
        "Free T4異常を認めた。高値は甲状腺ホルモン過剰、低値は甲状腺ホルモン欠乏・粘液水腫を示唆する",
    "ACTH":
        "ACTH異常を認めた。高値は副腎皮質不全・異所性ACTH産生腫瘍、低値は副腎性コルチゾール過剰・下垂体機能低下を示唆する",
    "コルチゾール":
        "コルチゾール異常を認めた。高値はコルチゾール過剰産生、低値は副腎皮質不全・副腎クリーゼを示唆する",
    "PTH (副甲状腺ホルモン)":
        "PTH異常を認めた。高値はPTH自律分泌・反応性過剰分泌、低値はPTH分泌低下を示唆する",
    "アルドステロン":
        "アルドステロン異常を認めた。高値はアルドステロン自律分泌、低値は副腎皮質不全を示唆する",

    # --- 病原体特異的検査（病原体名は保持、疾患名を除去）---
    "尿中肺炎球菌抗原":
        "尿中肺炎球菌抗原陽性を認めた。肺炎球菌（グラム陽性双球菌）感染を示す",
    "尿中レジオネラ抗原":
        "尿中レジオネラ抗原陽性を認めた。レジオネラ・ニューモフィラ（血清群1）感染を示す",
    "HIV-RNA定量":
        "HIV-RNA陽性を認めた。HIV感染のウイルス量が検出された",
    "HIVスクリーニング (Ag/Ab)":
        "HIVスクリーニング陽性を認めた。HIV感染を示唆する（確認検査が必要）",
    "RPR (梅毒定性/定量)":
        "RPR陽性を認めた。トレポネーマ感染の活動性を示唆する（生物学的偽陽性の可能性も考慮）",
    "TP抗体":
        "TP抗体陽性を認めた。トレポネーマの既感染または現在の感染を示す",
    "クリプトコッカス抗原":
        "クリプトコッカス抗原陽性を認めた。クリプトコッカス真菌感染を示す",
    "インターフェロンγ遊離試験 (IGRA: T-SPOT/QFT)":
        "IGRA陽性を認めた。結核菌感染（潜在性または活動性）を示す",
    "EBウイルス抗体 (VCA-IgG/IgM, EBNA)":
        "EBウイルス抗体パターン異常を認めた。VCA-IgM陽性+EBNA陰性は急性感染（伝染性単核球症）、VCA-IgG陽性+EBNA陽性は既感染を示す",
    "HTLV-1抗体":
        "HTLV-1抗体陽性を認めた。HTLV-1感染を示す。関連リンパ系腫瘍・脊髄症の発症リスクを示唆する",
    "サイトメガロウイルス抗体 (IgG/IgM)":
        "サイトメガロウイルスIgM抗体陽性を認めた。CMV初感染または再活性化を示す",
    "マイコプラズマPCR":
        "マイコプラズマ・ニューモニエの核酸が検出された。非定型起炎菌による肺感染が確認された",
    "結核菌PCR":
        "結核菌群の核酸が検出された。検体から結核菌DNAが増幅陽性であった",
    "抗酸菌培養":
        "検体から抗酸菌が培養陽性となった。結核菌群または非結核性抗酸菌が同定された",

    # --- 自己抗体系（疾患名→メカニズム/カテゴリ）---
    "抗dsDNA抗体":
        "抗dsDNA抗体陽性を認めた。核成分に対する自己免疫応答の活動性を示す",
    "抗Sm抗体":
        "抗Sm抗体陽性を認めた。核内snRNPに対する自己抗体で全身性自己免疫疾患に特異的",
    "抗RNP抗体":
        "抗RNP抗体陽性を認めた。核内RNPに対する自己抗体で重複結合組織疾患に関連",
    "抗Scl-70抗体":
        "抗Scl-70抗体陽性を認めた。トポイソメラーゼIに対する自己抗体で全身性結合組織硬化に特異的",
    "抗核抗体 (ANA)":
        "抗核抗体陽性を認めた。核成分に対する自己抗体で全身性自己免疫疾患のスクリーニングに使用",
    "抗CCP抗体":
        "抗CCP抗体陽性を認めた。シトルリン化蛋白に対する自己抗体で自己免疫性滑膜炎に高い特異性を持つ",
    "リウマトイド因子 (RF)":
        "リウマトイド因子陽性を認めた。IgGのFc部に対する自己抗体で自己免疫性滑膜炎・外分泌腺炎症を示唆する",
    "抗Jo-1抗体":
        "抗Jo-1抗体陽性を認めた。アミノアシルtRNA合成酵素に対する自己抗体で炎症性筋疾患・肺間質障害を示唆する",
    "抗SS-A抗体":
        "抗SS-A抗体陽性を認めた。Ro抗原に対する自己抗体で外分泌腺破壊・全身性自己免疫を示唆する",
    "抗SS-B抗体":
        "抗SS-B抗体陽性を認めた。La抗原に対する自己抗体で外分泌腺の自己免疫性破壊に特異的",
    "抗セントロメア抗体":
        "抗セントロメア抗体陽性を認めた。セントロメア蛋白に対する自己抗体で限局型結合組織硬化に特異的",
    "抗リン脂質抗体 (抗CL/β2GPI)":
        "抗リン脂質抗体陽性を認めた。血栓形成傾向と習慣性流産を伴う自己免疫性凝固異常を示唆する",
    "抗ミトコンドリア抗体 (AMA)":
        "抗ミトコンドリア抗体陽性を認めた。胆管上皮の自己免疫性破壊に高い特異性を持つ",
    "抗サイログロブリン抗体":
        "抗サイログロブリン抗体陽性を認めた。甲状腺組織に対する自己免疫反応を示唆する",
    "抗TPO抗体":
        "抗TPO抗体陽性を認めた。甲状腺ペルオキシダーゼに対する自己抗体で自己免疫性甲状腺破壊を示唆する",
    "TSH受容体抗体 (TRAb/TSAb)":
        "TSH受容体抗体陽性を認めた。TSH受容体への刺激性自己抗体で甲状腺ホルモン過剰産生を引き起こす",
    "PR3-ANCA":
        "PR3-ANCA（c-ANCA）陽性を認めた。好中球プロテイナーゼ3に対する自己抗体で肉芽腫性小血管炎を強く示唆する",
    "MPO-ANCA":
        "MPO-ANCA（p-ANCA）陽性を認めた。好中球ミエロペルオキシダーゼに対する自己抗体で壊死性小血管炎を示唆する",

    # --- 腫瘍マーカー（癌種名→臓器・組織記述）---
    "CEA":
        "CEA高値を認めた。腺癌（消化管・肺の腺上皮由来悪性腫瘍）を示唆する",
    "CA19-9":
        "CA19-9高値を認めた。膵胆道系の悪性腫瘍・消化管腫瘍を示唆する",
    "CA125":
        "CA125高値を認めた。卵巣の悪性腫瘍・腹膜病変・胸水を示唆する",
    "AFP":
        "AFP高値を認めた。肝の原発性悪性腫瘍・胚細胞性腫瘍を示唆する。慢性肝障害でも軽度上昇する",
    "PIVKA-II":
        "PIVKA-II高値を認めた。肝の原発性悪性腫瘍を示唆する。ワーファリン投与時も上昇する",
    "CA15-3":
        "CA15-3高値を認めた。乳腺の悪性腫瘍（特に転移性）を示唆する",
    "PSA":
        "PSA高値を認めた。前立腺の腫瘍性増殖・炎症・肥大を示唆する",
    "ST-439":
        "ST-439高値を認めた。膵胆道系・消化管の悪性腫瘍を示唆する",
    "可溶性IL-2受容体 (sIL-2R)":
        "可溶性IL-2受容体高値を認めた。リンパ増殖性腫瘍の活動性を示唆する",
    "サイログロブリン":
        "サイログロブリン異常を認めた。甲状腺組織の破壊・増殖を反映する",
    "BCR-ABL融合遺伝子":
        "BCR-ABL融合遺伝子陽性を認めた。チロシンキナーゼ活性化による骨髄系・リンパ系腫瘍性増殖を示す",
    "JAK2遺伝子変異":
        "JAK2遺伝子変異陽性を認めた。JAK-STAT経路の構成的活性化による骨髄増殖性腫瘍を示唆する",
    "BRCA1/2遺伝子検査":
        "BRCA1/2遺伝子変異陽性を認めた。DNA修復障害による遺伝性腫瘍リスク増大・PARP阻害薬適応を示唆する",

    # --- 画像検査（疾患名を所見記述に）---
    "12誘導心電図":
        "心電図異常を認めた。ST上昇（心筋壊死）、ST低下（虚血）、異常Q波（陳旧性壊死）、心房の異常電気活動、伝導障害、QT延長、右軸偏位（肺血管閉塞）、低電位差（心嚢液貯留）を認めた",
    "胸部CT (造影)":
        "胸部造影CTで異常を認めた。肺動脈内の充盈欠損（血栓閉塞）、大動脈のintimal flap（壁解離）、リンパ節腫大の造影パターンを認めた",
    "腹部CT (造影ダイナミック)":
        "腹部造影ダイナミックCTで異常を認めた。動脈相で早期濃染する腫瘤（肝・腎の悪性腫瘍）、門脈相でwashout、血管閉塞・血栓、膵臓の造影不良域を認めた",
    "注腸造影":
        "注腸造影で異常を認めた。apple core sign（大腸悪性腫瘍）、thumb printing（腸管虚血）、鉛管像（慢性大腸粘膜炎症）、skip lesion（消化管全層性炎症）を認めた",
    "経食道心エコー (TEE)":
        "経食道心エコーで異常を認めた。弁の疣贅（心内膜微生物感染）、左房内血栓、弁逆流・弁膜異常の詳細評価、大動脈壁解離のintimal flapを認めた",
    "運動負荷心電図 (マスター/トレッドミル)":
        "運動負荷心電図でST変化を認めた。労作時冠動脈虚血による心筋酸素需給不均衡を示唆する",
    "ホルター心電図 (24時間)":
        "ホルター心電図で不整脈を認めた。発作性心房異常電気活動、心室期外収縮、洞機能障害、伝導障害、ST変化を認めた",
    "腹部X線 (KUB)":
        "腹部X線で異常を認めた。ニボー像（腸管通過障害）、free air（管腔臓器破綻）、結石（腎・尿管）、腸管拡張、石灰化（膵・大動脈）を認めた",
    "甲状腺シンチグラフィ":
        "甲状腺シンチグラフィで異常を認めた。びまん性集積亢進（自己免疫性過形成）、結節への限局的集積（機能性結節）、冷結節（悪性腫瘍の可能性）を認めた",
    "ガリウムシンチグラフィ":
        "ガリウムシンチグラフィで異常集積を認めた。リンパ増殖性腫瘍、肉芽腫性疾患、感染巣（膿瘍）を示唆する",
    "副腎シンチグラフィ":
        "副腎シンチグラフィで異常を認めた。副腎腺腫への限局的集積（アルドステロン自律分泌の局在診断）、MIBG集積（カテコラミン産生腫瘍）を認めた",
    "PET-CT (FDG)":
        "PET-CTでFDG集積異常を認めた。悪性腫瘍の原発巣・転移巣（高集積）、全身性炎症性疾患にも集積を認めた",
    "肺血流シンチグラフィ":
        "肺血流シンチグラフィで異常を認めた。区域性の血流欠損（肺動脈血栓閉塞）を認めた",
    "ドパミントランスポーターシンチ (ダットスキャン)":
        "ダットスキャンで異常を認めた。線条体のドパミントランスポーター集積低下を認めた。黒質ドパミン神経変性を示唆する",
    "脳血流シンチグラフィ (SPECT)":
        "脳血流SPECTで異常を認めた。局所的な脳血流低下を認めた。神経変性性認知障害の鑑別に有用",
    "乳房MRI":
        "乳房MRIで異常を認めた。造影増強を伴う腫瘤、非腫瘤性増強効果を認めた。乳腺悪性腫瘍の範囲評価に異常",
    "マンモグラフィ":
        "マンモグラフィで異常を認めた。腫瘤影、微小石灰化（集簇性）、構築の乱れ、非対称性陰影を認めた。乳腺悪性腫瘍のスクリーニングに異常所見",
    "心臓MRI":
        "心臓MRIで異常を認めた。遅延造影（心筋壊死・炎症・線維化）、壁運動異常、心筋浮腫（T2高信号）を認めた",
    "下肢静脈超音波":
        "下肢静脈超音波で異常を認めた。深部静脈内の血栓エコー、圧迫による非虚脱性（静脈内血栓形成）を認めた",
    "前立腺超音波 (経直腸)":
        "前立腺超音波で異常を認めた。前立腺腫大、低エコー領域（悪性腫瘍疑い）を認めた",
    "膀胱鏡検査":
        "膀胱鏡で異常を認めた。膀胱粘膜の腫瘤性病変、炎症、出血源を認めた",

    # --- 呼吸機能・特殊検査 ---
    "呼吸機能検査 (スパイロメトリー)":
        "呼吸機能異常を認めた。閉塞性障害（FEV1/FVC低下：気流制限性肺疾患）、拘束性障害（%VC低下：肺間質障害・胸壁疾患）、混合性障害を認めた",
    "呼気NO濃度 (FeNO)":
        "呼気NO濃度上昇を認めた。好酸球性気道炎症を示唆する",
    "一酸化炭素拡散能 (DLco)":
        "DLco低下を認めた。肺間質障害、肺胞壁破壊、肺血管抵抗上昇による拡散障害を示唆する",
    "6分間歩行試験":
        "6分間歩行距離の低下を認めた。心肺機能低下・肺血管抵抗上昇による運動耐容能低下",

    # --- 脳波・筋電図 ---
    "脳波検査":
        "脳波異常を認めた。棘波・棘徐波複合（異常脳電気活動）、周期性鋭波（プリオン病）、局所性徐波（局所脳病変）、全般性徐波（代謝性脳症）を認めた",
    "筋電図 (EMG)":
        "筋電図異常を認めた。線維自発電位（脱神経）、筋原性変化（炎症性筋疾患・遺伝性筋変性）、神経原性変化（運動ニューロン変性・脊髄障害）を認めた",

    # --- 内視鏡 ---
    "下部消化管内視鏡 (CF)":
        "下部消化管内視鏡で異常を認めた。ポリープ（腺腫・過形成）、腫瘤性病変、潰瘍（慢性粘膜炎症・全層性炎症）、憩室、虚血性変化を認めた",
    "小腸カプセル内視鏡":
        "小腸カプセル内視鏡で異常を認めた。小腸粘膜の潰瘍（全層性炎症）、血管異形成、腫瘤、出血源を認めた",

    # --- 眼底 ---
    "眼底検査":
        "眼底検査で異常を認めた。出血（微小血管障害）、乳頭浮腫（頭蓋内圧亢進）、ドルーゼン（黄斑変性）、cherry red spot（網膜動脈閉塞）を認めた",
    "フルオレセイン蛍光眼底造影 (FAG)":
        "FAGで異常を認めた。蛍光漏出（新生血管・血管透過性亢進）、無灌流域（微小血管閉塞）、充盈遅延（動脈閉塞）を認めた",

    # --- 嗅覚 ---
    "嗅覚検査 (静脈性/T&T)":
        "嗅覚異常を認めた。鼻副鼻腔病変・神経変性疾患による嗅覚路障害を示唆する",

    # --- 生検・カテーテル ---
    "右心カテーテル (Swan-Ganz)":
        "右心カテーテルで異常を認めた。肺動脈圧上昇（肺血管抵抗上昇）、肺動脈楔入圧上昇（左心機能不全）、心拍出量低下を認めた",
    "筋生検":
        "筋生検で異常を認めた。筋線維の壊死・再生、炎症細胞浸潤（炎症性筋疾患）、perifascicular atrophy（血管周囲炎症）、dystrophin欠損（遺伝性筋変性）を認めた",

    # --- 非標準フォーマット項目（完全書き換え）---
    "KL-6":
        "KL-6高値を認めた。肺間質の炎症・線維化の活動性、薬剤性肺障害、自己免疫性肺病変を示唆する",
    "クームス試験（直接/間接）":
        "クームス試験陽性を認めた。直接陽性は赤血球表面への自己抗体結合（免疫介在性溶血）、間接陽性は血清中の遊離抗体を示す",
    "補体（C3/C4/CH50）":
        "補体低下を認めた。免疫複合体形成による消費性低下、補体活性化経路の亢進、肝合成能低下、先天性補体成分欠損を示唆する",
    "末梢血塗抹標本":
        "末梢血塗抹標本で形態異常を認めた。赤血球形態異常（小球性低色素性・大球性・破砕・球状）、白血球異常（芽球出現・過分葉好中球）、血小板異常、赤血球内寄生体を認めた",
    "ハプトグロビン":
        "ハプトグロビン低値を認めた。血管内溶血による消費、肝合成能低下を示唆する。炎症では反応性に上昇する",
    "D-dimer":
        "Dダイマー上昇を認めた。血栓形成・線溶亢進、凝固障害、大血管壁損傷を示唆する。術後・外傷・妊娠でも非特異的に上昇する",

    # --- その他の個別修正 ---
    "カリウム (K)":
        "血清カリウム異常を認めた。高カリウム血症は腎機能障害・副腎皮質不全・薬剤性、低カリウム血症は消化管喪失・アルドステロン過剰・利尿薬を示唆する",
    "ナトリウム (Na)":
        "血清ナトリウム異常を認めた。低値はADH不適切分泌・心機能不全・肝障害・利尿薬、高値は脱水・ADH欠乏を示唆する",
    "カルシウム (Ca)":
        "血清カルシウム異常を認めた。高値はPTH過剰・悪性腫瘍関連・肉芽腫性疾患、低値はPTH低下・ビタミンD欠乏・腎機能障害を示唆する",
    "無機リン (P)":
        "血清リン異常を認めた。高値は腎機能障害・PTH低下、低値はPTH過剰・くる病・リフィーディングを示唆する",
    "血糖 (随時/空腹時)":
        "血糖異常を認めた。高値は糖代謝異常・ストレス高血糖・コルチゾール過剰、低値はインスリン過剰・副腎皮質不全を示唆する",
    "HbA1c":
        "HbA1c高値を認めた。過去1-2ヶ月間の血糖コントロール不良、持続的な糖代謝異常を示唆する",
    "C-ペプチド (CPR)":
        "C-ペプチド異常を認めた。低値はβ細胞破壊・インスリン分泌低下、高値はインスリン抵抗性・インスリン産生腫瘍を示唆する",
    "インスリン (IRI)":
        "インスリン異常を認めた。高値+低血糖はインスリン産生腫瘍、高値+高血糖はインスリン抵抗性を示唆する",
    "IGF-1 (ソマトメジンC)":
        "IGF-1異常を認めた。高値は成長ホルモン過剰・下垂体腫瘍、低値は成長ホルモン分泌不全を示唆する",
    "成長ホルモン (GH)":
        "GH異常を認めた。高値は下垂体からのGH自律分泌、低値はGH分泌不全を示唆する",
    "レニン活性 / レニン濃度":
        "レニン-アルドステロン比異常を認めた。レニン低値+アルドステロン高値はアルドステロン自律分泌、レニン高値は腎動脈狭窄を示唆する",
    "カテコラミン3分画 (アドレナリン/ノルアド/ドーパミン)":
        "血中カテコラミン高値を認めた。カテコラミン産生腫瘍を示唆する",
    "血中ケトン体":
        "血中ケトン体上昇を認めた。インスリン欠乏によるケトン体蓄積、飢餓性ケトーシス、アルコール性ケトーシスを示唆する",
    "葉酸":
        "血清葉酸低値を認めた。巨赤芽球性造血障害、栄養不良、妊娠、抗痙攣薬使用を示唆する",

    # --- 凝固系 ---
    "Dダイマー":
        "Dダイマー上昇を認めた。血栓形成後の線溶亢進、播種性凝固障害、大血管壁損傷を示唆する",
    "FDP":
        "FDP上昇を認めた。播種性凝固障害、血栓形成、線溶亢進を示唆する",
    "フィブリノゲン":
        "フィブリノゲン異常を認めた。低値は播種性凝固障害・肝不全、高値は炎症・悪性腫瘍を示唆する",
    "PT-INR (プロトロンビン時間)":
        "PT-INR延長を認めた。肝障害、ビタミンK欠乏、播種性凝固障害、抗凝固薬過量、凝固因子欠乏を示唆する",
    "APTT (活性化部分トロンボプラスチン時間)":
        "APTT延長を認めた。凝固因子欠乏、ヘパリン使用中、ループスアンチコアグラント、播種性凝固障害、肝障害を示唆する",
    "アンチトロンビンIII":
        "アンチトロンビンIII低値を認めた。消費性凝固障害、肝障害、大量蛋白尿、先天性欠乏症を示唆する",

    # --- 髄液・胸腹水 ---
    "髄液一般 (細胞数/タンパク/糖/Cl)":
        "髄液異常を認めた。細胞数増加（好中球優位は細菌感染、単核球優位はウイルス・抗酸菌感染）、蛋白上昇、糖低下（細菌・抗酸菌・悪性細胞浸潤）を認めた",
    "髄液IgGインデックス":
        "髄液IgGインデックス上昇を認めた。中枢神経系での免疫グロブリン産生亢進（脱髄疾患・中枢神経肉芽腫）を示唆する",
    "胸水一般 (比重/タンパク/LDH/細胞数/細胞診)":
        "胸水検査異常を認めた。Light基準で滲出液（感染・悪性腫瘍・自己免疫疾患）か漏出液（心機能不全・肝障害・蛋白漏出）を鑑別",
    "腹水一般 (比重/タンパク/LDH/細胞数/細胞診)":
        "腹水検査異常を認めた。SAAG≧1.1は門脈圧亢進、SAAG<1.1は悪性腫瘍播種・抗酸菌感染を示唆する",
    "髄液検査 (髄液一般・生化学)":
        "髄液検査異常を認めた。細胞数増加、蛋白上昇、糖低下、開放圧上昇を認めた。細菌・ウイルス・抗酸菌感染、悪性細胞浸潤の鑑別が必要",

    # --- 尿検査 ---
    "尿定性 (タンパク/糖/潜血/ケトン/ビリルビン/ウロビリノーゲン/pH/比重)":
        "尿定性検査異常を認めた。蛋白尿は糸球体障害、尿糖は糖代謝異常、潜血は糸球体・尿路病変、ケトン体はケトーシスを示唆する",
    "尿沈渣 (赤血球/白血球/扁平上皮/移行上皮/硝子円柱/顆粒円柱/細菌)":
        "尿沈渣異常を認めた。赤血球円柱は糸球体障害、白血球円柱は腎実質感染、顆粒円柱は尿細管障害、変形赤血球は糸球体性血尿を示唆する",
    "尿中微量アルブミン":
        "尿中微量アルブミン陽性を認めた。高血糖による糸球体障害の早期（微量アルブミン尿期）を示唆する",
    "尿中Bence-Jonesタンパク":
        "尿中Bence-Jonesタンパク陽性を認めた。形質細胞の腫瘍性増殖によるM蛋白尿を強く示唆する",

    # --- 便 ---
    "便潜血反応 (2日法)":
        "便潜血陽性を認めた。大腸の悪性腫瘍・腺腫、慢性炎症性腸疾患、消化管出血を示唆する",

    # --- 生検（追加） ---
    "腎生検":
        "腎生検で糸球体基底膜異常、メサンギウム増殖、半月体形成、管内増殖、係蹄壊死、間質炎症細胞浸潤、尿細管壊死、血管炎、免疫蛍光でIgA・IgG・C3沈着が認められた",
    "経気管支肺生検 (TBLB)":
        "肺生検で非乾酪性肉芽腫、間質の線維化・炎症、器質化変化、悪性細胞、好酸球浸潤、感染性病変（真菌・抗酸菌）が認められた",
    "神経生検":
        "神経生検で異常を認めた。軸索変性、脱髄、血管炎、アミロイド沈着、肉芽腫を認めた",

    # --- 超音波・X線（追加） ---
    "腹部超音波":
        "腹部超音波で肝腫大、脂肪肝、肝内腫瘤、胆石、胆嚢壁肥厚、胆管拡張、膵腫大、腎石、水腎症、脾腫、腹水、大動脈拡大が認められた",

    # --- 血液ガス ---
    "血液ガス分析 (動脈)":
        "動脈血液ガス異常を認めた。呼吸性アシドーシス（CO2貯留）、呼吸性アルカローシス（過換気）、代謝性アシドーシス（AG上昇：乳酸・ケトン・腎機能障害、AG正常：腸管喪失・尿細管性）、代謝性アルカローシス（嘔吐・利尿薬）を認めた",
}

# ===================================================================
# 汎用 疾患名→メカニズム マッピング（オーバーライドにないものに適用）
# ===================================================================
DISEASE_MAP = {
    "全身性エリテマトーデス": "全身性自己免疫応答",
    "SLE": "全身性自己免疫疾患",
    "関節リウマチ": "自己免疫性滑膜炎",
    "心筋梗塞": "心筋壊死",
    "急性心筋梗塞": "急性心筋壊死",
    "心不全": "心機能不全",
    "肝硬変": "肝実質線維化",
    "腎不全": "腎機能障害",
    "糖尿病": "糖代謝異常",
    "急性膵炎": "膵実質急性炎症",
    "慢性膵炎": "膵実質慢性炎症",
    "膵炎": "膵実質障害",
    "DIC": "播種性凝固障害",
    "ITP": "免疫性血小板破壊",
    "TTP": "微小血管障害性血栓",
    "HUS": "微小血管障害性溶血",
    "白血病": "造血幹細胞腫瘍性増殖",
    "悪性リンパ腫": "リンパ増殖性腫瘍",
    "多発性骨髄腫": "形質細胞腫瘍性増殖",
    "ネフローゼ症候群": "大量蛋白尿性糸球体障害",
    "ネフローゼ": "糸球体蛋白漏出",
    "バセドウ病": "TSH受容体刺激性自己抗体",
    "橋本病": "自己免疫性甲状腺破壊",
    "甲状腺機能亢進症": "甲状腺ホルモン過剰",
    "甲状腺機能亢進": "甲状腺ホルモン過剰",
    "甲状腺機能低下症": "甲状腺ホルモン欠乏",
    "甲状腺機能低下": "甲状腺ホルモン欠乏",
    "褐色細胞腫": "カテコラミン産生腫瘍",
    "パラガングリオーマ": "傍神経節カテコラミン腫瘍",
    "クッシング症候群": "コルチゾール過剰",
    "アジソン病": "副腎皮質不全",
    "サルコイドーシス": "肉芽腫性疾患",
    "膠原病": "全身性自己免疫疾患",
    "シェーグレン症候群": "外分泌腺自己免疫破壊",
    "大動脈解離": "大血管壁損傷",
    "深部静脈血栓症": "深部静脈血栓形成",
    "肺血栓塞栓症": "肺動脈血栓閉塞",
    "DVT": "深部静脈血栓",
    "鉄欠乏性貧血": "鉄欠乏",
    "溶血性貧血": "赤血球破壊亢進",
    "血管炎": "血管壁炎症",
    "てんかん": "異常脳電気活動",
    "間質性肺炎": "肺間質炎症",
    "肺線維症": "肺間質線維化",
    "COPD": "気流制限性肺疾患",
    "喘息": "気道過敏性",
    "大腸癌": "大腸悪性腫瘍",
    "胃癌": "胃悪性腫瘍",
    "膵臓癌": "膵悪性腫瘍",
    "肝細胞癌": "肝原発悪性腫瘍",
    "肺塞栓": "肺血管閉塞",
    "骨髄増殖性疾患": "骨髄増殖性腫瘍",
    "巨細胞性動脈炎": "大血管の肉芽腫性炎症",
    "副甲状腺機能亢進症": "PTH過剰分泌",
    "副甲状腺機能低下症": "PTH分泌低下",
    "先端巨大症": "GH過剰",
    "原発性アルドステロン症": "アルドステロン自律分泌",
    "潰瘍性大腸炎": "大腸粘膜慢性炎症",
    "クローン病": "消化管全層性肉芽腫性炎症",
    "IBD": "炎症性腸疾患",
}


def main():
    dry_run = "--dry-run" in sys.argv

    tests = []
    with open(TESTS_JSONL, "r", encoding="utf-8") as f:
        for line in f:
            if line.strip():
                tests.append(json.loads(line.strip()))

    print(f"全検査: {len(tests)}件")

    changed = 0
    map_applied = 0

    for t in tests:
        name = t["test_name"]
        old_ht = t.get("hypothesis_text", "")
        if not old_ht:
            continue

        # 1. 個別オーバーライド
        if name in OVERRIDES:
            new_ht = OVERRIDES[name]
            if old_ht != new_ht:
                if dry_run:
                    print(f"\n[OVERRIDE] {name}")
                    print(f"  OLD: {old_ht[:120]}...")
                    print(f"  NEW: {new_ht[:120]}...")
                t["hypothesis_text"] = new_ht
                changed += 1
            continue

        # 2. 汎用マッピング（長い名前から先に置換）
        new_ht = old_ht
        for disease_name in sorted(DISEASE_MAP.keys(), key=len, reverse=True):
            if disease_name in new_ht:
                new_ht = new_ht.replace(disease_name, DISEASE_MAP[disease_name])

        if new_ht != old_ht:
            if dry_run:
                print(f"\n[MAP] {name}")
                print(f"  OLD: {old_ht[:120]}...")
                print(f"  NEW: {new_ht[:120]}...")
            t["hypothesis_text"] = new_ht
            changed += 1
            map_applied += 1

    print(f"\n変更: {changed}件 (override: {changed - map_applied}, map: {map_applied})")

    if not dry_run and changed > 0:
        with open(TESTS_JSONL, "w", encoding="utf-8") as f:
            for t in tests:
                f.write(json.dumps(t, ensure_ascii=False) + "\n")
        print(f"書き込み完了: {TESTS_JSONL}")
        print("\n次のステップ:")
        print("  del data\\sim_matrix.npz  # キャッシュ削除")
    elif dry_run:
        print("\n--dry-run: 書き込みは行いません")


if __name__ == "__main__":
    main()
