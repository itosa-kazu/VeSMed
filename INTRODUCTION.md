# VeSMed — ベクトル空間医学統一フレームワーク

## 概要

VeSMed（Vector Space Medicine）は、**ベクトル空間（embedding）を用いて医学の診断プロセスを統一的に記述するフレームワーク**です。

患者情報をベクトル化し、疾患データベースとの類似度検索により候補疾患を抽出。さらに情報利得（information gain）に基づいて最も有用な検査を推薦します。検査結果が得られるたびに再ベクトル検索を行い、候補疾患が動的に更新されます。

## 理論的背景

### 核心的アイデア

医学における診断・検査選択・治療を、すべて**ベクトル空間上の操作**として統一的に記述できるという仮説に基づいています。

1. **患者情報 → ベクトル** — 症状・年齢・性別・検査結果をテキスト化し、embeddingモデルでベクトル空間に射影
2. **疾患 → ベクトル** — 各疾患の臨床的特徴をLLMで構造化記述し、同じベクトル空間に射影
3. **診断 = 最近傍探索** — 患者ベクトルに最も近い疾患ベクトルが候補疾患
4. **検査選択 = 情報利得最大化** — 候補疾患間の不確実性を最も減少させる検査を推薦
5. **検査結果 → 再検索** — 新しい情報が加わるたびに患者ベクトルが更新され、候補疾患が動的に変化

### ベイズ更新ではなくベクトル再検索を採用する理由

従来のCDSS（臨床意思決定支援システム）はベイズ更新で確率を逐次更新しますが、VeSMedでは**検査結果が出るたびにベクトル検索をやり直します**。

- 検査結果を含む患者テキスト全体を再embeddingすることで、ベクトル空間上の患者の位置が移動する
- これにより、初回検索では候補に入らなかった疾患が新たに浮上する可能性がある
- ベイズ更新の「初回候補に固定される」制約がない

### 先行研究との関係

| 手法 | 代表的システム | VeSMedとの違い |
|------|---------------|---------------|
| 重み付きスコアリング | DXplain, Isabel | 確率的推論なし |
| ナイーブベイズ + 手動Se/Sp | QMR-DT, Iliad | 手動キュレーション必要 |
| LLM直接推定 | ChatGPT, AMIE | 非決定的、校正不良 |
| **ベクトル検索 + 情報利得** | **VeSMed** | **LLM蒸留メタデータ + 再検索ループ** |

## システム構成

```
┌─────────────────────────────────────────────────────┐
│                    VeSMed アーキテクチャ               │
├─────────────────────────────────────────────────────┤
│                                                     │
│  [患者情報テキスト]                                    │
│        │                                            │
│        ▼                                            │
│  LLMクエリ書き換え (Gemini 3 Pro)                     │
│        │                                            │
│        ▼                                            │
│  Embeddingモデル (Qwen3-Embedding-8B, 4096次元)       │
│        │                                            │
│        ▼                                            │
│  ベクトル検索 (ChromaDB, 384疾患)                     │
│        │                                            │
│        ▼                                            │
│  候補疾患 Top-K + 類似度 → softmax → 事前確率          │
│        │                                            │
│        ▼                                            │
│  情報利得計算 → 検査推薦ランキング                      │
│        │                                            │
│        ▼                                            │
│  [検査所見入力] ──→ 患者テキスト更新 ──→ 再検索ループ   │
│                                                     │
└─────────────────────────────────────────────────────┘
```

## データ生成

疾患・検査のメタデータはすべて**LLMによる知識蒸留**で生成しています。

- **384疾患**: 各疾患について、典型的症状・年齢分布・性差・緊急度・関連検査（Se/Sp付き）などの構造化データをLLMが生成
- **検査データ**: 各検査について、検出可能な疾患・コスト・侵襲度・報告時間などをLLMが生成
- **ベクトルDB**: 疾患の臨床的記述をembeddingし、ChromaDBに格納

患者データを一切使用しないため、選択バイアス（来院患者の偏り）の影響を受けません。

## 使用技術

| コンポーネント | 技術 |
|--------------|------|
| LLM | Gemini 3 Pro Preview (lemonapi.site経由) |
| Embedding | Qwen3-Embedding-8B (4096次元) |
| ベクトルDB | ChromaDB |
| Web UI | Gradio |
| 言語 | Python |

## ファイル構成

```
VeSMed/
├── config.py          # API設定・パラメータ（環境変数から読み込み）
├── generate.py        # LLMによる疾患・検査メタデータ生成（非同期30並列）
├── index.py           # 疾患記述のembedding → ChromaDB構築
├── engine.py          # 核心エンジン（検索・情報利得計算・検査推薦）
├── normalize.py       # 検査名の名寄せ処理
├── web.py             # Gradio Web UI
├── main.py            # CLI版インターフェース
├── requirements.txt   # 依存パッケージ
├── .env.example       # 環境変数テンプレート
└── data/
    ├── diseases.jsonl      # 384疾患メタデータ
    ├── tests.jsonl         # 検査メタデータ
    ├── findings.jsonl      # 所見データ
    ├── test_name_map.json  # 検査名 名寄せマップ
    └── chroma_db/          # ベクトルDB（要再構築）
```

## 動作の流れ（具体例）

### ケース: 67歳男性、7週間の繰り返す発熱

**Step 1 — 初回分析**
```
入力: 「67歳の男性。繰り返す発熱を主訴に来院。7週間前から38℃前後の発熱」
→ ベクトル検索 → 候補: 感染性心内膜炎、肝膿瘍、膿胸、結核 ...
→ 推薦検査: 血液培養、心エコー、胸部CT ...
```

**Step 2 — 心エコー実施**
```
入力: 「大動脈弁逆流あり」
→ 患者テキスト + 心エコー結果で再ベクトル検索
→ 感染性心内膜炎の順位が上昇
→ 推薦検査: 経食道心エコー(TEE)、血液培養 ...
```

**Step 3 — 血液培養実施**
```
入力: 「黄色ブドウ球菌陽性」
→ 再ベクトル検索 → 感染性心内膜炎が1位に
→ 推薦検査: TEE（疣贅確認）、Roth斑、Osler結節 ...
```

検査を重ねるごとに、ベクトル空間上で患者の位置が正しい疾患に近づいていきます。

## 今後の展望

1. **治療推薦**: 治療をベクトル空間上の平移操作として記述（drug + treats ≈ disease）
2. **生存分析**: 死亡領域からの距離を最大化する治療選択
3. **個性化Se/Sp**: 患者特徴に応じた検査精度の動的推定
4. **多施設検証**: MIMIC-IV等の公開データセットでの回顧的検証

---

# セットアップ手順（教授向け）

## 必要なもの

- Windows PC（Mac/Linuxでも可）
- インターネット接続

## 手順

### 1. Pythonのインストール

Pythonがまだ入っていない場合：

1. https://www.python.org/downloads/ にアクセス
2. 「Download Python 3.12.x」をクリック
3. インストーラを実行。**「Add Python to PATH」にチェックを入れてからInstall**

確認方法：コマンドプロンプトで以下を入力
```
python --version
```
「Python 3.12.x」のように表示されればOK。

### 2. プロジェクトのダウンロード

#### 方法A: Gitを使う場合

Gitがインストール済みなら：
```
git clone https://github.com/itosa-kazu/VeSMed.git
cd VeSMed
```

#### 方法B: ZIPでダウンロード（Gitがない場合）

1. ブラウザで https://github.com/itosa-kazu/VeSMed にアクセス
2. 緑色の「Code」ボタンをクリック
3. 「Download ZIP」をクリック
4. ダウンロードしたZIPを展開（右クリック → 「すべて展開」）
5. コマンドプロンプトで展開したフォルダに移動：
```
cd C:\Users\（ユーザー名）\Downloads\VeSMed-main
```

### 3. 依存パッケージのインストール

コマンドプロンプトで：
```
pip install -r requirements.txt
```

### 4. APIキーの設定

プロジェクトフォルダ内の `.env.example` をコピーして `.env` にリネーム：
```
copy .env.example .env
```

`.env` をメモ帳で開き、APIキーを入力：
```
LLM_API_KEY=（LLM用のAPIキーをここに貼り付け）
EMBEDDING_API_KEY=（Embedding用のAPIキーをここに貼り付け）
```

※ APIキーは別途お渡しします。

### 5. ベクトルDBの構築

初回のみ必要です（数分かかります）：
```
python index.py
```

### 6. 起動

```
python web.py
```

ブラウザが自動的に開き、VeSMedの画面が表示されます。
表示されない場合は、ブラウザで http://localhost:7860 にアクセスしてください。

## 使い方

1. 「患者情報」欄に患者の情報を自由記述で入力
2. 「分析開始」をクリック → 候補疾患と推薦検査が表示される
3. 検査を選択し、所見を入力して「所見を反映」をクリック
4. 候補疾患と推薦検査が更新される → 繰り返し

## トラブルシューティング

| 症状 | 対処法 |
|------|--------|
| `python` が認識されない | Pythonインストール時に「Add to PATH」にチェックを入れ直す |
| `pip install` でエラー | `python -m pip install -r requirements.txt` を試す |
| APIエラー | `.env` ファイルのAPIキーが正しいか確認 |
| ベクトルDB関連エラー | `python index.py` を再実行 |
