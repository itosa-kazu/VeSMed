# VeSMed Embedding テキスト設計相談

## 1. システム概要（前提知識）

VeSMedは488疾患×340検査×279問診項目の類似度行列で検査推薦を行うシステムです。

```
sim_matrix[疾患i][検査j] = cos(disease_emb_i, test_hypothesis_emb_j)
sim_matrix_hpe[疾患i][HPE項目k] = cos(disease_emb_i, hpe_hypothesis_emb_k)
```

- **疾患側（行）**: `findings_description`（平均18,000字の臨床記述）をembedding
- **検査側（列）**: `hypothesis_text`（50-100字の短文）をembedding
- **HPE側（列）**: `hypothesis`（30-60字のキーワード列）をembedding
- embeddingモデル: Qwen3-Embedding-8B（4096次元、32Kトークン対応）

### sim_matrixの使われ方

```python
# Part A: 鑑別推奨 = 候補疾患群内での検査スコア分散が大きい検査
variance_j = Σ w_i × (sim[i][j] - μ_j)²

# Part C: 確定推奨 = 候補群平均 - 全疾患平均（候補群に特異的な検査）
confirm_j = cluster_mu_j - global_mu_j

# Part E: 基本推奨 = 候補群の加重平均（共通して必要な検査）
cluster_mu_j = Σ w_i × sim[i][j]
```

つまりsim_matrixの値の「絶対値」だけでなく「疾患間の相対的な大小関係」が検査推薦の精度を決定します。

---

## 2. 全件監査で判明した問題

### 2.1 疾患名カンニング（最深刻）

#### 問題の構造

hypothesis_textに特定の疾患名を含めると：
```
hypothesis_text = "抗dsDNA抗体陽性を認めた。全身性エリテマトーデスの活動性を示唆する"
                                                ~~~~~~~~~~~~~~~~~~~~~~~~
disease_description(SLE) = "...全身性エリテマトーデス（SLE）は自己免疫疾患で..."

→ cos(hypothesis_emb, SLE_desc_emb) が他の疾患より不当に高い
→ 表層的な文字列一致によるバイアス（臨床的関連性ではない）
```

#### 規模

| カテゴリ | 汚染件数 / 総数 | 割合 |
|---------|----------------|------|
| HPE hypothesis | 53 / 279 | 19% |
| 検査 hypothesis_text（特定疾患名） | ~80 / 340 | 24% |
| 検査（病原体特異的検査での病原体名） | 35 / 340 | 10% |
| 検査（腫瘍マーカーでの特定癌名） | 14 / 340 | 4% |

#### 代表例

**HPE（症候項目に疾患名）:**
```
NG: "盗汗 寝汗 夜間発汗 結核 悪性リンパ腫 B症状"
OK: "盗汗 寝汗 夜間発汗 着替えが必要 シーツが濡れる"

NG: "項部硬直 頸部硬直 受動的頸部前屈で抵抗 髄膜炎 SAH"
OK: "項部硬直 頸部硬直 受動的頸部前屈で抵抗 髄膜刺激徴候"

NG: "Murphy徴候 陽性 右季肋部圧痛 吸気時停止 急性胆嚢炎"
OK: "Murphy徴候 右季肋部深触診で吸気停止 圧痛"
```

**検査（hypothesis_textに疾患名）:**
```
NG: "抗dsDNA抗体陽性を認めた。全身性エリテマトーデスの活動性を示唆する"
OK: "抗dsDNA抗体陽性を認めた。全身性の自己免疫応答の活動性を示唆する"

NG: "カテコラミン3分画高値を認めた。褐色細胞腫、パラガングリオーマを示唆する"
OK: "カテコラミン3分画高値を認めた。カテコラミン産生腫瘍を示唆する"
```

**病原体特異的検査（特殊ケース）:**
```
"尿中肺炎球菌抗原陽性を認めた。肺炎球菌感染を示唆する"
→ 「肺炎球菌」は病原体名であり疾患名ではない
→ しかしembedding空間では肺炎球菌性肺炎のdescriptionとだけ近くなる
→ 他の細菌性肺炎（レジオネラ、黄色ブドウ球菌等）との相対関係が歪む
```

### 2.2 無関係概念の混入

HPEのhypothesisに「結果として起きる別の症状」が含まれるパターン:

```
NG: "体重増加 浮腫 腹水 全身性浮腫 甲状腺機能低下"
     ^^^^  ^^^^             ^^^^^^^^^^
     別の所見              疾患名

OK: "体重増加 意図しない増加 数ヶ月の経過 BMI上昇"
```

**薬剤歴項目が特に深刻:**
```
NG: "ACE阻害薬 エナラプリル リシノプリル 服用中 咳嗽 血管浮腫"
                                              ^^^^  ^^^^^^
                                              別の症状（副作用）
```
→ 「ACE阻害薬服用中」のhypothesisに「咳嗽」が入ると、咳嗽関連疾患とのsim_matrix_hpeが不当に上がる。

### 2.3 極性の問題（検査側）

9件のhypothesis_textが「増加または減少」の両方向を含む:
```
NG: "血小板数の増加または減少を認めた。ITP, TTP, HUS, DIC, 骨髄増殖性疾患を示唆する"
→ 血小板増加と血小板減少は全く異なる疾患群を示唆
→ embeddingは「増加」と「減少」の方向を区別できない
→ 増加疾患と減少疾患の両方にcos類似度が高くなり、鑑別力が失われる
```

### 2.4 フォーマット不統一（検査 #332-340）

340件中、#1-331は「検査結果の異常を認めた。〜を示唆する」の統一フォーマット。
#332-340は「疾患名で結果」というリスト形式で、完全に異なる文体。

### 2.5 HPEの既往歴項目（構造的ジレンマ）

既往歴項目（「糖尿病」「冠動脈疾患」等）は、item_name自体が疾患名。
```
"糖尿病 2型糖尿病 HbA1c上昇 血糖管理不良 合併症"
```
→ 既往歴として「糖尿病あり」を記録するための項目なので、疾患名は避けられない
→ しかしembeddingでは糖尿病のdescriptionとだけcos類似度が高くなる
→ sim_matrix_hpeの更新で糖尿病が不当に浮上する

---

## 3. 設計上の問い

### Q1: hypothesis_textの設計原則

疾患名カンニングを除去するとして、何で置き換えるべきか？

**選択肢:**
- **A: 臨床カテゴリ名** — 「SLE」→「全身性自己免疫疾患」、「褐色細胞腫」→「カテコラミン産生腫瘍」
- **B: 病態記述** — 「SLE」→「自己抗体による多臓器障害」、「褐色細胞腫」→「副腎髄質由来のカテコラミン過剰産生」
- **C: 完全除去** — 疾患への言及を一切含めず、検査所見のみ記述

例えば抗dsDNA抗体の場合:
```
A: "抗dsDNA抗体陽性を認めた。全身性の自己免疫応答の活動性を示唆する"
B: "抗dsDNA抗体陽性を認めた。自己抗体による核成分攻撃、多臓器の免疫複合体沈着を示唆する"
C: "抗dsDNA抗体陽性を認めた"
```

### Q2: 病原体特異的検査の扱い

「尿中肺炎球菌抗原」のhypothesisから「肺炎球菌」を除去すると、検査の意味が消える。しかし含めると肺炎球菌性肺炎のdescriptionとだけcos類似度が偏る。

**選択肢:**
- **A: 病原体名は許容** — 検査の本質的意味なので仕方ない
- **B: 上位カテゴリ化** — 「肺炎球菌」→「グラム陽性球菌」「市中肺炎の代表的起炎菌」
- **C: 検査→疾患の直接マッピング** — sim_matrixではなく、メタデータで関連疾患を定義

### Q3: 極性分割（増加 vs 減少）

血小板数、白血球数、赤血球数など、増加と減少で示唆疾患が全く異なる検査がある。

**選択肢:**
- **A: 検査自体を分割** — 「血小板数（増加）」と「血小板数（減少）」を別項目に
- **B: 異常方向のみ記述** — 「減少を認めた」だけにして、増加は別パス
- **C: 現状維持** — embeddingの限界として受容

### Q4: 既往歴項目のhypothesis

既往歴（「糖尿病」「冠動脈疾患」等）のhypothesisは疾患名を含まざるを得ない。

**選択肢:**
- **A: 影響を受容** — 既往歴は本来的にその疾患と関連するので、sim_matrix_hpeが高くなるのは正しい
- **B: 併存症記述に変換** — 「糖尿病 → 血糖コントロール不良 インスリン抵抗性 微小血管障害リスク」
- **C: HPE更新から既往歴カテゴリを除外** — 既往歴はフィルタ情報としてのみ使用

### Q5: 薬剤歴項目のhypothesis

薬剤歴（「ACE阻害薬」「ステロイド」等）のhypothesisに副作用が混入している。

**選択肢:**
- **A: 薬剤名のみ** — 副作用を全除去
- **B: 薬効記述** — 「ACE阻害薬 → アンジオテンシン変換酵素阻害 降圧薬 レニン-アンジオテンシン系抑制」
- **C: HPE更新から薬剤歴カテゴリを除外** — Q4-Cと同じ

### Q6: そもそものアーキテクチャ

現在のsim_matrixは `cos(disease_emb, hypothesis_emb)` で計算されています。
hypothesisテキストの品質問題がこれほど大規模（全619件中約180件に問題）だとすると：

- hypothesisの修正で十分か？
- それとも、sim_matrixの計算方式自体を変えるべきか？
- 例: 検査と疾患の関連度をLLMで直接スコアリングする方が正確では？（コスト大だが）

---

## 4. 添付データ

- `hypothesis_texts_for_review.jsonl`（123KB）: 全619件のhypothesis/hypothesis_text
- `disease_sample_for_review.jsonl`（84KB）: 疾患findings_descriptionのサンプル1件（肺炎球菌性肺炎、33K字）
